<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D3.js</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="css/style.css">
</head>
<body>
<div class="container">
    <header class="main-header">
        <div class="header-container">Learning D3.JS</div>
    </header>

    <div class="row">

        <div class="blocks">
            <div class="displayb checkblock">
                <span class="block_name">HTML</span>
                <div class="infotype" id="html_editor"></div>
            </div>

            <div class="displayb infotheory">
                <span class="block_name">JavaScript</span>
                <div class="infotype" id="js_editor"></iframe>
                </div>
            </div>

        </div>
        <div class="tasks">
            <div class="massiv">
                <span class="block_name">Massiv</span>
                <div class="block_massiv"></div>
            </div>
            <div class="block2 example">
                <span class="block_name">Образец</span>
                <iframe id="example_iframe" class="iframeblock"></iframe>
            </div>
            <div class="block2 itog">
                <iframe id="result_iframe" class="iframeblock"></iframe>
                <a class="btn newinfo" href="#"><i class="fa fa-info-circle"></i>Информация</a>
                <a class="btn checkbtn" onclick="compare()"><i class="fa fa-thumbs-up" ></i>CHECK</a>
            </div>
        </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
    <script src="js/html2canvas.js"></script>
    <script src="js/resemble.js"></script>
    <script src="ace-builds/src-min-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
    <script>
        var example_canvas;
        var result_canvas;

        var example_html =
                '<html>\n' +
                '<head>\n' +
                '\t<title>Result</title>\n' +
                '\t<style>\n' +
                '\t\t.chart div {\n' +
                '\t\t\tfont: 10px sans-serif;\n' +
                '\t\t\tbackground-color: steelblue;\n' +
                '\t\t\ttext-align: right;\n' +
                '\t\t\tpadding: 3px;\n' +
                '\t\t\tmargin: 1px;\n' +
                '\t\t\tcolor: white;\n' +
                '\t\t}\n' +
                '\t</style>\n' +
                '</head>\n' +
                '<body>\n' +
                '\t<div class="chart"></div>\n' +
                '\t<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"><\/script>\n' +
                '</body>\n' +
                '</html>';

        var array_data = 'var data = [5, 8, 13, 21, 34, 18];';

        var example_js =
                'var x = d3.scale.linear()\n' +
                '\t.domain([0, d3.max(data)])\n' +
                '\t.range([0, 578]);\n' +
                '\n' +
                'd3.select(".chart")\n' +
                '\t.selectAll("div")\n' +
                '\t.data(data)\n' +
                '\t.enter().append("div")\n' +
                '\t.style("width", function(d) { return x(d) + "px"; })\n' +
                '\t.text(function(d) { return d; });'


        var result_iframe = document.getElementById('result_iframe');
        var in_result_iframe = result_iframe.contentDocument || result_iframe.contentWindow.document;

        var example_iframe = document.getElementById('example_iframe');
        var in_example_iframe = example_iframe.contentDocument || example_iframe.contentWindow.document;

        in_example_iframe.open();
        in_example_iframe.write(example_html + "<script>" + array_data + example_js + "<\/script>");
        in_example_iframe.close();

        var js_editor = ace.edit("js_editor");
        js_editor.setTheme("ace/theme/github");
        js_editor.getSession().setMode("ace/mode/javascript");
        js_editor.setValue(
                'var x = d3.scale.linear()\n' +
                '\t.domain([0, d3.max(data)])\n' +
                '\t.range([0, 578]);\n' +
                '\n' +
                'd3.select(".chart")\n' +
                '\t.selectAll("div")\n' +
                '\t.data(data)\n' +
                '\t.enter().append("div")\n' +
                '\t.style("width", function(d) { return x(d) + "px"; })\n' +
                '\t.text(function(d) { return d; });'
        );


        in_result_iframe.open();
        in_result_iframe.write(example_html + "<script>" + array_data + js_editor.getValue() + "<\/script>");
        in_result_iframe.close();

        js_editor.getSession().on('change', function () {
            in_result_iframe.open();
            in_result_iframe.write(example_html + "<script>" + array_data + js_editor.getValue() + "<\/script>");
            in_result_iframe.close();
        });

        function compare() {
            html2canvas(in_example_iframe.body, {
                onrendered: function (ex_canvas) {
                    example_canvas = ex_canvas;
                    html2canvas(in_result_iframe.body, {
                        onrendered: function (res_canvas) {
                            result_canvas = res_canvas;
                            var example_string = example_canvas.toDataURL("image/jpeg", 1.0);
                            var result_string = result_canvas.toDataURL("image/jpeg", 1.0);
                            resemble(result_string).compareTo(example_string).onComplete(function (data) {
                                console.log(data.rawMisMatchPercentage);
//                                var snackbarContainer = document.querySelector('#compare-result');
//                                var text_data;
//                                var masmatch_percentage = data.rawMisMatchPercentage;
//                                if (masmatch_percentage == 0) {
//                                    text_data = {message: "Данные идентичны. Можете переходить к следующему заданию"};
//                                    $("#btn-next").prop("disabled", false);
//                                    $("#i-next").removeClass("md-inactive");
//                                } else {
//                                    text_data = {message: "Данные не совпадают. Попорбуйте еще раз"};
//                                }
//                                snackbarContainer.MaterialSnackbar.showSnackbar(text_data);
//                                bar_match.MaterialProgress.setProgress(100 - masmatch_percentage);
//                                $(".card.match .title").text("Совпадение данных: " + Math.round(100 - masmatch_percentage) + "%");
                            });

                        }
                    });
                }
            });
        }
    </script>
</div>
</body>
</html>