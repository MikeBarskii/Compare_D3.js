<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D3.js</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="css/style.css">
</head>
<body>
<div class="container">
    <header class="main-header">
        <div class="header-container">Learning D3.JS</div>
    </header>

    <div class="row">

        <div class="blocks">
            <div class="displayb checkblock">
                <span class="block_name">HTML</span>
                <div class="infotype" id="html_editor"></div>
            </div>

            <div class="displayb infotheory">
                <span class="block_name">JavaScript</span>
                <div class="infotype" id="js_editor"></iframe>
                </div>
            </div>

        </div>
        <div class="tasks">
            <div class="massiv">
                <span class="block_name">Massiv</span>
                <div class="block_massiv">var data = [5, 8, 13, 21, 34, 18];</div>
            </div>
            <div class="block2 example">
                <span class="block_name">Образец</span>
                <iframe id="example_iframe" class="iframeblock"></iframe>
            </div>
            <div class="block2 itog">
                <iframe id="result_iframe" class="iframeblock"></iframe>
                <label class="btn newinfo" style="font-family: 'Helvetica', sans-serif;"
                       for="modal-1">Информация</label>
                <button class="btn checkbtn" onclick="compare()"><i class="fa fa-thumbs-up"></i>CHECK</button>
                <button class="btn btn-default procent_result" id="result_button">0%</button>
            </div>
        </div>
    </div>

    <!-- Modal Window -->
    <div class="modal">
        <input class="modal-open" id="modal-1" type="checkbox" hidden>
        <div class="modal-wrap" aria-hidden="true" role="dialog">
            <label class="modal-overlay" for="modal-1"></label>
            <div class="modal-dialog">
                <div class="modal-header">
                    <h2>Модальное окно на CSS! :-)</h2>
                    <label class="btn-close" for="modal-1" aria-hidden="true">×</label>
                </div>
                <div class="modal-body">
                    <p>Это всего лишь один небольшой пример :D</p>
                </div>
                <div class="modal-footer">
                    <label class="btn btn-primary" for="modal-1">Отлично!</label>
                </div>
            </div>
        </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
    <script src="js/html2canvas.js"></script>
    <script src="js/resemble.js"></script>
    <script src="ace-builds/src-min-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
    <script>
        var example_canvas;
        var result_canvas;

        var example_html =
                '<html>\n' +
                '<head>\n' +
                '\t<title>Result</title>\n' +
                '\t<style>\n' +
                ' path {\n' +
                '     stroke: steelblue;\n' +
                '     stroke-width: 1;\n' +
                '    fill: none;\n' +
                '}\n' +

                ' .axis {\n' +
                '    shape-rendering: crispEdges;\n' +
                ' }\n' +

                '.x.axis line {\n' +
                '    stroke: lightgrey;\n' +
                '}\n' +

                '.x.axis .minor {\n' +
                '   stroke-opacity: .5;\n' +
                ' }\n' +

                '.x.axis path {\n' +
                '   display: none;\n' +
                '}\n' +

                '.y.axis line, .y.axis path {\n' +
                '   fill: none;\n' +
                '   stroke: #000;\n' +
                '}\n' +
                '\t\t.chart div {\n' +
                '\t\t\tfont: 10px sans-serif;\n' +
                '\t\t\tbackground-color: steelblue;\n' +
                '\t\t\ttext-align: right;\n' +
                '\t\t\tpadding: 3px;\n' +
                '\t\t\tmargin: 1px;\n' +
                '\t\t\tcolor: white;\n' +
                '\t\t}\n' +
                '\t</style>\n' +
                '</head>\n' +
                '<body>\n' +
                '\t<div id="graph" class="aGraph" style="position:absolute;top:0px;left:0; float:left;"></div>\n' +
                '\t<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"><\/script>\n' +
                '</body>\n' +
                '</html>';

        //        var array_data = 'var data = [5, 8, 13, 21, 34, 18];';
        var array_data = 'var data = [3, 6, 2, 7, 5, 2, 0, 3, 8, 9, 2, 5, 9, 3, 6, 3, 6, 2, 7, 5, 2, 1, 3, 8, 9, 2, 5, 9, 2, 7];';

        var example_js =
                // define dimensions of graph
                'var m = [80, 80, 80, 80]; // margins\n' +
                'var w = 1000 - m[1] - m[3]; // width\n' +
                'var h = 400 - m[0] - m[2]; // height\n' +

//        // create a simple data array that we'll plot with a line (this array represents only the Y values, X will just be the index location)
//        var data = [3, 6, 2, 7, 5, 2, 0, 3, 8, 9, 2, 5, 9, 3, 6, 3, 6, 2, 7, 5, 2, 1, 3, 8, 9, 2, 5, 9, 2, 7];

                // X scale will fit all values from data[] within pixels 0-w
                'var x = d3.scale.linear().domain([0, data.length]).range([0, w]);\n' +
                // Y scale will fit values from 0-10 within pixels h-0 (Note the inverted domain for the y-scale: bigger is up!)
                'var y = d3.scale.linear().domain([0, 10]).range([h, 0]);\n' +
                // automatically determining max range can work something like this
                // var y = d3.scale.linear().domain([0, d3.max(data)]).range([h, 0]);

                // create a line function that can convert data[] into x and y points
                'var line = d3.svg.line()\n' +
                // assign the X function to plot our line as we wish
                '      .x(function(d,i) {\n' +
                // verbose logging to show what's actually being done
                //            console.log('Plotting X value for data point: ' + d + ' using index: ' + i + ' to be at: ' + x(i) + ' using our xScale.');
                // return the X coordinate where we want to plot this datapoint
                '            return x(i);\n' +
                '        })\n' +
                '        .y(function(d) {\n' +
                // verbose logging to show what's actually being done
                //console.log('Plotting Y value for data point: ' + d + ' to be at: ' + y(d) + " using our yScale.");
                // return the Y coordinate where we want to plot this datapoint
                '             return y(d);\n' +
                '        })\n' +

                // Add an SVG element with the desired dimensions and margin.
                ' var graph = d3.select("#graph").append("svg:svg")\n' +
                '       .attr("width", w + m[1] + m[3])\n' +
                '       .attr("height", h + m[0] + m[2])\n' +
                '       .append("svg:g")\n' +
                '       .attr("transform", "translate(" + m[3] + "," + m[0] + ")");\n' +

                // create yAxis
                'var xAxis = d3.svg.axis().scale(x).tickSize(-h).tickSubdivide(true);\n' +
                // Add the x-axis.
                'graph.append("svg:g")\n' +
                '       .attr("class", "x axis")\n' +
                '       .attr("transform", "translate(0," + h + ")")\n' +
                '        .call(xAxis);\n' +


                // create left yAxis
                ' var yAxisLeft = d3.svg.axis().scale(y).ticks(4).orient("left");\n' +
                // Add the y-axis to the left
                'graph.append("svg:g")\n' +
                '        .attr("class", "y axis")\n' +
                '        .attr("transform", "translate(-25,0)")\n' +
                '        .call(yAxisLeft);\n' +

                // Add the line by appending an svg:path element with the data line we created above
                // do this AFTER the axes above so that the line is above the tick-lines
                ' graph.append("svg:path").attr("d", line(data));'


        //        var example_js =
        //                'var x = d3.scale.linear()\n' +
        //                '\t.domain([0, d3.max(data)])\n' +
        //                '\t.range([0, 578]);\n' +
        //                '\n' +
        //                'd3.select(".chart")\n' +
        //                '\t.selectAll("div")\n' +
        //                '\t.data(data)\n' +
        //                '\t.enter().append("div")\n' +
        //                '\t.style("width", function(d) { return x(d) + "px"; })\n' +
        //                '\t.text(function(d) { return d; });'


        var result_iframe = document.getElementById('result_iframe');
        var in_result_iframe = result_iframe.contentDocument || result_iframe.contentWindow.document;

        var example_iframe = document.getElementById('example_iframe');
        var in_example_iframe = example_iframe.contentDocument || example_iframe.contentWindow.document;

        in_example_iframe.open();
        in_example_iframe.write(example_html + "<script>" + array_data + example_js + "<\/script>");
        in_example_iframe.close();

        var js_editor = ace.edit("js_editor");
        js_editor.setTheme("ace/theme/github");
        js_editor.getSession().setMode("ace/mode/javascript");
        js_editor.setValue(
                'var x = d3.scale.linear()\n' +
                '\t.domain([0, d3.max(data)])\n' +
                '\t.range([0, 578]);\n' +
                '\n' +
                'd3.select(".chart")\n' +
                '\t.selectAll("div")\n' +
                '\t.data(data)\n' +
                '\t.enter().append("div")\n' +
                '\t.style("width", function(d) { return x(d) + "px"; })\n' +
                '\t.text(function(d) { return d; });'
        );


        in_result_iframe.open();
        in_result_iframe.write(example_html + "<script>" + array_data + js_editor.getValue() + "<\/script>");
        in_result_iframe.close();

        js_editor.getSession().on('change', function () {
            in_result_iframe.open();
            in_result_iframe.write(example_html + "<script>" + array_data + js_editor.getValue() + "<\/script>");
            in_result_iframe.close();
        });

        function compare() {
            <!-- Iframe to Canvas-->
            html2canvas(in_example_iframe.body, {
                onrendered: function (ex_canvas) {
                    example_canvas = ex_canvas;
                    html2canvas(in_result_iframe.body, {
                        onrendered: function (res_canvas) {
                            result_canvas = res_canvas;
                            var example_string = example_canvas.toDataURL("image/jpeg", 1.0);
                            var result_string = result_canvas.toDataURL("image/jpeg", 1.0);
                            <!-- Compare 2 Iframes -->
                            resemble(result_string).compareTo(example_string).onComplete(function (data) {
                                document.getElementById('result_button').innerHTML = (100 - data.rawMisMatchPercentage) + ' %';
                            });
                        }
                    });
                }
            });
        }
    </script>
</div>
</body>
</html>